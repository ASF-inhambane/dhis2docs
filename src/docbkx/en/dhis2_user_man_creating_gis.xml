<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.4//EN" "http://www.oasis-open.org/docbook/xml/4.4/docbookx.dtd" []>
<chapter>
  <title>Setting up GIS</title>
  <section>
    <title>Context</title>
    <para>
      Setting up the GIS simply means storing coordinates for the organisation units you want to show on the map in the database. Coordinates are distributed in shapefiles, which is the most common geospatial vector data format for desktop applications (you might find shapefiles for your country at http://www.diva-gis.org/gdata). The work that needs to be done in order to use these coordinates in DHIS 2 GIS is transfering them and storing them with the corresponding organisation units in the database.
    </para>
    <para>If you go to the organisation unit module and edit one of the units, you can see a textfield called Coordinates. Here you may fill in its coordinates directly (geojson format) which is quite neat if you just want to update a couple of units. However, if you are going to e.g. add coordinates for all units at a certain level you don't want to do that manually. This is where the automatic GML import comes into play and the following section explains the preferred way of using it.
    </para>
  </section>
  <section id="gisSetup">
    <title>Importing coordinates</title>
    <para>Step 1 - Simplify/generalize your shapefile</para>
    <para>
      The boundaries in shapefiles are usually very accurate. This does not cause any trouble for hardware accelerated desktop based GIS software, but it might be too heavy for the web based GIS application in DHIS 2. Thus, we need to make the boundary lines less detailed by removing some of the line points. Go to http://mapshaper.com/test/demo.html and upload your shapefile. Then, at the center bottom you see a slider that starts at 0%. It is usually ok to drag it up to about 80%. In the left menu you can check "show original lines" to compare the result and you may want to give a different simplification method a try. When you are happy with the result, click "export" in the top right corner. Then check the first of the four options called "Shapefile - polygons", click "create" and wait for the download buttons to appear. Now, download the two files and overwrite the existing .shp and .shx files in your shapefile set (a shapefile is actually a set that has three mandatory files called .shp, .shx and .dbf and sometimes up to 15 files in total). Move on to the next step with your new simplified shapefile.
    </para>
    <para></para>
    <para>Step 2 - Convert the shapefile to GML</para>
    <para>
      The recommended tool for geographical format conversions is called "ogr2ogr". This should be available for most Linux distros ("sudo apt-get install gdal-bin"). For Windows, go to http://fwtools.maptools.org/ and download "FWTools". During the format conversion we also want to ensure that the output has the correct coordinate projection (called EPSG:4326 with regular longitude and latitude). We can do this with the "-t_srs" flag (means "transform spatial reference system"). The command syntax is: "ogr2ogr -t_srs output_proj -f output_format output_file.output_format input_file.input_format". Now, if we have a shapefile called "sl_districts" and want to convert it to GML, use the following command: <programlisting><userinput> ogr2ogr -t_srs EPSG:4326 -f GML sl_districts.gml sl_districts.shp </userinput></programlisting> You will find the created GML file in the same folder as the shapefile.
    </para>
    <para></para>
    <para>Step 3 - Prepare the GML file</para>
    <para>
      Unfortunately, the GML file is not likely to be ready for importation yet. Open it in a robust text editor like Geany (Linux) or Notepad++ (Windows). The DHIS 2 importer will look for a property called "ogr:Name" in this file when it matches the GML file to the organisation units in the database. Figure out what property that is holding the name of the organisation unit (could be "ogr:DISTRICT_NAME" or whatever, this differs from shapefile to shapefile) and rename it to "ogr:Name". Ensure that both the start tag and the end tag is renamed properly, they are supposed to look like this: &lt;ogr:Name&gt;Moyamba District&lt;/ogr:Name&gt;
    </para>
    <para>
      Note that the name of the organisation units in the GML file must be spelled exactly the same as the organisation units in the database. Otherwise the importer will not recognize it and thus not transfer any coordinates. E.g. "Moyamba" in the GML file migth be called "Moyamba District" in the database. Creative use of the "rename all" function in the text editor is usually of great help in these situations.
    </para>
    <para>
      Now, go to Services -> Import-Export, upload the file, select "Preview" and click "Import". Look for new/updated organisation units. If the intention is to add coordinates to already existing organisation units in the database, you want as many as updates as possible and 0 new. Those listed as new will be created as root units and mess up the organisation unit trees in DHIS 2. In the GML file, remove the organisation units that were listed as new and run preview again. When there are 0 new, switch the import type from "Preview" to "Import" and click the "Import" button. If it completes successfully, skip step 4.
    </para>
    <para></para>
    <para>Step 4 - Fix possible error causes</para>
    <para>
      Common error causes are:
      <para>- Name duplicates in the GML file. The name column in the database is unique and does not accept two organisation units with the same name.</para>
      <para>- The "shortname" database column has a too small varchar definition. Increase it to 100.</para>
      <para>- Special name characters in the GML file. Rename or remove.</para>
    </para>
    <para>
      Finally, retry the GML file importation.
    </para>   
  </section>
  <section>
    <title>Administering the GIS module</title>
    <section id="gisAdministratorSettings">
      <title>Administrator settings</title>
      <para>
        Administrator settings are available only to users with admin rights. The administrator settings window can be opened from the map toolbar, click on the gears symbol (tooltip says "Administrator settings").
      </para>
      <para>
        - Google Maps: In order to have Google Maps as background you need to fill in an Google Maps API key created for the domain the applcation is running on. The default key works for localhost. If you want to set up GIS on an external server you have to create and fill in the key for this domain, more info here http://code.google.com/apis/maps/signup.html. You will be provided with a link such as: http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key=ABQIAAAAut6AhySExnYIXm5s2OFIkxRKNzJ-_9njnryRTbvC6CtrS4sRvRREWnxwlZUa630pLuPf3nD9i4fq9w. Note that you are supposed to fill in the key only, i.e. the encrypted string that follows after "key=", not the entire link.
          <screenshot>
            <screeninfo>Layer options</screeninfo>
            <mediaobject>
              <imageobject>
                <imagedata width="50%" fileref="resources/images/gis/gis_google_key.png" format="PNG"/>
              </imageobject>
            </mediaobject>
          </screenshot>
      </para>
      <para>
        - Date: Choose between fixed periods and start/end dates. Fixed periods refers to the periods created by the DHIS 2. Start/end dates means that you can define the period yourself by selecting the exact start date and end date of the period.
      </para>
    </section>
    <section id="gisOverlay">
      <title>Register overlays</title>
      <para>Overlays are geographical layers that do not have any direct linkage
    to data in the database. Examples include roads, rivers, airports, ports,
    and other geographical information that you may want to display on your
    map, but that is not necessarily linked to data contained in the DHIS
    database. The <guimenu>Register Overlay</guimenu> panel will allow you to
    add new layers and determine how they will be represented visually on the
    map. </para>
      <itemizedlist>
        <listitem>
          <para><guilabel>Display name: </guilabel>Represents your overlay in
        the layer tree in the upper right corner.</para>
        </listitem>
        <listitem>
          <para><guilabel>Map source file: </guilabel>The GeoJSON file
        name.</para>
        </listitem>
        <listitem>
          <para><guilabel>Fill color: </guilabel>Decides the fill color if the
        layer is a polygon layer. </para>
        </listitem>
        <listitem>
          <para><guilabel>Fill opacity: </guilabel>Select an opacity level
        between 0 (invisible) and 1 (solid).</para>
        </listitem>
        <listitem>
          <para><guilabel>Stroke color: </guilabel>The stroke color over lines
        and polygon borders.</para>
        </listitem>
        <listitem>
          <para><guilabel>Stroke width: </guilabel>Select a stroke width between
        0 and 4.</para>
        </listitem>
      </itemizedlist>
      <section>
        <title>Copying files to the DHIS application</title>
        <para>Currently, your GeoJSON files should be placed in the
      DHIS2_HOME/geojson of your DHIS application to be accessible to the GIS
      module. If the GeoJSON directory does not exist, you will need to create
      it manually and copy your GeoJSON files there.</para>
      </section>
    </section>
  </section>
</chapter>
